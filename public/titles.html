<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAQ Titles Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/components.css">
</head>
<body class="bg-primary text-primary">
  <div id="app" class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 shadow-lg">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <!-- Left: Logo and navigation -->
          <div class="flex items-center space-x-8">
            <a href="/" class="text-white text-xl font-bold hover:text-blue-200 transition-colors">
              📊 Keywords Cluster Tool
            </a>
            <nav class="hidden md:flex items-center space-x-4 text-sm">
              <a href="/" class="text-blue-100 hover:text-white transition-colors px-3 py-2 rounded-md">Dashboard</a>
              <span class="text-blue-200">›</span>
              <span id="project-name-breadcrumb" class="text-blue-100">Project</span>
              <span class="text-blue-200">›</span>
              <span class="text-white font-medium">FAQ Titles</span>
            </nav>
          </div>
          
          <!-- Right: Control buttons -->
          <div class="flex items-center space-x-3">
            <button id="theme-toggle" class="relative w-12 h-6 bg-white bg-opacity-20 rounded-full transition-all duration-200 cursor-pointer">
              <div id="theme-slider" class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-transform duration-200 shadow-sm"></div>
            </button>
          </div>
        </div>
      </div>
    </header>
    
    <!-- Main content -->
    <main class="flex-1 bg-gray-50 dark:bg-gray-900">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading state -->
        <div id="loading" class="text-center py-16">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full mb-6">
            <div class="animate-spin rounded-full h-8 w-8 border-2 border-white border-t-transparent"></div>
          </div>
          <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-2">Loading FAQ Titles</h2>
          <p class="text-gray-600 dark:text-gray-400">Fetching your generated content...</p>
        </div>
      
        <!-- Project info -->
        <div id="project-info" class="mb-8 hidden">
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-3">🎯 Generated FAQ Titles</h1>
          <p class="text-lg text-gray-600 dark:text-gray-400" id="project-subtitle">Loading...</p>
        </div>
      
        <!-- No titles message -->
        <div id="no-titles" class="text-center py-16 hidden">
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-12 max-w-2xl mx-auto">
            <div class="text-8xl mb-6">📝</div>
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">No FAQ Titles Yet</h2>
            <p class="text-xl text-gray-600 dark:text-gray-400 mb-6">This project doesn't have any generated FAQ titles.</p>
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-6 mb-8">
              <p class="text-blue-800 dark:text-blue-200 font-medium">💡 Getting Started</p>
              <p class="text-blue-700 dark:text-blue-300 mt-2">Use the CLI command "Generate More Content" to create FAQ titles from your keyword clusters.</p>
            </div>
            <a href="/" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-200 shadow-lg">
              ← Back to Dashboard
            </a>
          </div>
        </div>
      
        <!-- Titles content -->
        <div id="titles-content" class="hidden">
          <!-- Stats and controls -->
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
              <div class="flex items-center space-x-6">
                <div class="text-center">
                  <div id="titles-count" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Total Titles</div>
                </div>
                <div class="text-center">
                  <div id="clusters-count" class="text-2xl font-bold text-purple-600 dark:text-purple-400">0</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Clusters</div>
                </div>
              </div>
              <div class="flex flex-wrap gap-3">
                <!-- View switcher -->
                <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                  <button id="detailed-view-btn" class="px-3 py-1 text-sm font-medium rounded-md transition-colors bg-blue-500 text-white">
                    📋 Detailed
                  </button>
                  <button id="plain-view-btn" class="px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">
                    📄 Plain Text
                  </button>
                </div>
                
                <a href="/" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                  ← Dashboard
                </a>
                <a id="project-link" href="#" class="px-4 py-2 bg-blue-100 dark:bg-blue-700 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-600 transition-colors">
                  🗂️ Project Keywords
                </a>
                <button id="export-titles" class="px-4 py-2 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg hover:from-green-600 hover:to-blue-600 transition-all duration-200 shadow-md">
                  📊 Export CSV
                </button>
              </div>
            </div>
          </div>
          
          <!-- Clusters container (detailed view) -->
          <div id="clusters-container" class="space-y-8">
            <!-- Clusters with titles will be rendered here -->
          </div>
          
          <!-- Plain text container -->
          <div id="plain-text-container" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">📄 All FAQ Titles (Plain Text)</h3>
                <div class="flex gap-2">
                  <button id="mark-used-btn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                    ✅ Mark as Used
                  </button>
                  <button id="mark-unused-btn" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                    ↩️ Mark as Unused
                  </button>
                </div>
              </div>
              
              <!-- Filter Toolbar -->
              <div id="filter-toolbar" class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 mb-4 border border-gray-200 dark:border-gray-700">
                <div class="flex flex-col lg:flex-row gap-4">
                  <!-- Filter Controls -->
                  <div class="flex flex-col sm:flex-row gap-3 flex-1">
                    <!-- Date Filter -->
                    <div class="flex-1 min-w-0 relative">
                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">📅 Date</label>
                      <div class="relative">
                        <button id="date-filter-btn" class="w-full px-3 py-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-left flex justify-between items-center">
                          <span id="date-filter-text">Date (0 selected)</span>
                          <svg class="w-4 h-4 transition-transform" id="date-filter-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                          </svg>
                        </button>
                        <div id="date-filter-dropdown" class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg hidden">
                          <div class="p-2">
                            <div class="flex justify-between mb-2">
                              <button id="date-select-all" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Select All</button>
                              <button id="date-deselect-all" class="text-xs text-gray-500 dark:text-gray-400 hover:underline">Deselect All</button>
                            </div>
                            <label class="flex items-center p-1 hover:bg-gray-50 dark:hover:bg-gray-600 rounded">
                              <input type="checkbox" value="today" class="date-filter-checkbox mr-2">
                              <span class="text-sm">Today</span>
                            </label>
                            <label class="flex items-center p-1 hover:bg-gray-50 dark:hover:bg-gray-600 rounded">
                              <input type="checkbox" value="week" class="date-filter-checkbox mr-2">
                              <span class="text-sm">This Week</span>
                            </label>
                            <label class="flex items-center p-1 hover:bg-gray-50 dark:hover:bg-gray-600 rounded">
                              <input type="checkbox" value="month" class="date-filter-checkbox mr-2">
                              <span class="text-sm">This Month</span>
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Cluster Filter -->
                    <div class="flex-1 min-w-0 relative">
                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">🏷️ Cluster</label>
                      <div class="relative">
                        <button id="cluster-filter-btn" class="w-full px-3 py-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-left flex justify-between items-center">
                          <span id="cluster-filter-text">Cluster (0 selected)</span>
                          <svg class="w-4 h-4 transition-transform" id="cluster-filter-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                          </svg>
                        </button>
                        <div id="cluster-filter-dropdown" class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg hidden max-h-60 overflow-y-auto">
                          <div class="p-2">
                            <div class="flex justify-between mb-2">
                              <button id="cluster-select-all" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Select All</button>
                              <button id="cluster-deselect-all" class="text-xs text-gray-500 dark:text-gray-400 hover:underline">Deselect All</button>
                            </div>
                            <div id="cluster-options">
                              <!-- Cluster options will be populated dynamically -->
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Quality Filter -->
                    <div class="flex-1 min-w-0 relative">
                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">⭐ Quality</label>
                      <div class="relative">
                        <button id="quality-filter-btn" class="w-full px-3 py-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-left flex justify-between items-center">
                          <span id="quality-filter-text">Quality (0 selected)</span>
                          <svg class="w-4 h-4 transition-transform" id="quality-filter-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                          </svg>
                        </button>
                        <div id="quality-filter-dropdown" class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg hidden">
                          <div class="p-2">
                            <div class="flex justify-between mb-2">
                              <button id="quality-select-all" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Select All</button>
                              <button id="quality-deselect-all" class="text-xs text-gray-500 dark:text-gray-400 hover:underline">Deselect All</button>
                            </div>
                            <label class="flex items-center p-1 hover:bg-gray-50 dark:hover:bg-gray-600 rounded">
                              <input type="checkbox" value="high" class="quality-filter-checkbox mr-2">
                              <span class="text-sm">High (>80%)</span>
                            </label>
                            <label class="flex items-center p-1 hover:bg-gray-50 dark:hover:bg-gray-600 rounded">
                              <input type="checkbox" value="medium" class="quality-filter-checkbox mr-2">
                              <span class="text-sm">Medium (50-80%)</span>
                            </label>
                            <label class="flex items-center p-1 hover:bg-gray-50 dark:hover:bg-gray-600 rounded">
                              <input type="checkbox" value="low" class="quality-filter-checkbox mr-2">
                              <span class="text-sm">Low (<50%)</span>
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Usage Status Filter -->
                    <div class="flex-1 min-w-0 relative">
                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">📝 Status</label>
                      <div class="relative">
                        <button id="status-filter-btn" class="w-full px-3 py-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-left flex justify-between items-center">
                          <span id="status-filter-text">Status (0 selected)</span>
                          <svg class="w-4 h-4 transition-transform" id="status-filter-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                          </svg>
                        </button>
                        <div id="status-filter-dropdown" class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg hidden">
                          <div class="p-2">
                            <div class="flex justify-between mb-2">
                              <button id="status-select-all" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Select All</button>
                              <button id="status-deselect-all" class="text-xs text-gray-500 dark:text-gray-400 hover:underline">Deselect All</button>
                            </div>
                            <label class="flex items-center p-1 hover:bg-gray-50 dark:hover:bg-gray-600 rounded">
                              <input type="checkbox" value="unused" class="status-filter-checkbox mr-2">
                              <span class="text-sm">🆕 Unused</span>
                            </label>
                            <label class="flex items-center p-1 hover:bg-gray-50 dark:hover:bg-gray-600 rounded">
                              <input type="checkbox" value="used" class="status-filter-checkbox mr-2">
                              <span class="text-sm">✅ Used</span>
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Action Buttons -->
                  <div class="flex flex-col sm:flex-row gap-2 items-start sm:items-end">
                    <button id="clear-filters" class="px-4 py-2 text-sm bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
                      🗑️ Clear Filters
                    </button>
                    <div id="filter-status" class="text-sm text-gray-600 dark:text-gray-400 whitespace-nowrap">
                      <span id="filtered-count">0</span> of <span id="total-count">0</span> titles
                      <span id="active-filters" class="ml-2 text-blue-600 dark:text-blue-400 font-medium"></span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 font-mono text-sm">
                <textarea id="plain-text-content" class="w-full h-96 bg-transparent border-none outline-none resize-none text-gray-700 dark:text-gray-300 font-mono text-sm" placeholder="Filtered titles will appear here. You can delete lines you don't want to mark as used.">
                  <!-- Plain text titles will be rendered here -->
                </textarea>
              </div>
              <div class="mt-4 text-xs text-gray-500 dark:text-gray-400">
                💡 Tip: You can edit the text area - delete lines you don't want to mark as used. When you click "Mark as Used", only the remaining lines will be processed one by one.
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <!-- Footer -->
    <footer class="bg-gray-800 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex items-center justify-between">
          <span id="status-text" class="text-sm text-gray-400">Ready</span>
          <div class="text-xs text-gray-500">
            Keywords Cluster Tool © 2024
          </div>
        </div>
      </div>
    </footer>
  </div>
  
  <!-- Scripts -->
  <script src="js/theme-handler.js"></script>
  
  <script>
    let currentProject = null;
    let titlesData = null;
    let currentViewMode = 'detailed'; // 'detailed' or 'plain'
    
    // Filter state - now using arrays for multi-select
    let filterState = {
      date: [],
      cluster: [],
      quality: [],
      status: []
    };
    
    // Extract project ID from URL query parameter or path
    const urlParams = new URLSearchParams(window.location.search);
    let projectId = urlParams.get('project');
    
    // Fallback to path-based extraction for legacy URLs
    if (!projectId) {
      const pathParts = window.location.pathname.split('/');
      projectId = pathParts[2]; // /project/{id}/titles
    }
    
    if (!projectId) {
      alert('No project ID specified. Please use /titles?project=1 format.');
      window.location.href = '/';
    }
    
    // Load project and titles data
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        console.log('DEBUG: Current URL:', window.location.href);
        console.log('DEBUG: URL search params:', window.location.search);
        console.log('DEBUG: Extracted project ID:', projectId);
        console.log('Loading titles for project:', projectId);
        
        // Load dashboard to get project info
        const dashboardResponse = await fetch('/api/dashboard');
        const dashboardData = await dashboardResponse.json();
        
        // Find current project
        currentProject = dashboardData.projects.find(p => p.id == projectId);
        if (currentProject) {
          document.getElementById('project-name-breadcrumb').textContent = currentProject.name;
          document.title = `FAQ Titles - ${currentProject.name}`;
        } else {
          document.getElementById('project-name-breadcrumb').textContent = `Project ${projectId}`;
          document.title = `FAQ Titles - Project ${projectId}`;
        }
        
        // Set up project link
        document.getElementById('project-link').href = `/project.html?id=${projectId}`;
        
        // Load generated content with cache-busting timestamp
        const apiUrl = `/api/generated-content/${projectId}?_t=${Date.now()}`;
        console.log('DEBUG: Making API request to:', apiUrl);
        const titlesResponse = await fetch(apiUrl);
        if (!titlesResponse.ok) {
          throw new Error(`Failed to load titles: ${titlesResponse.status}`);
        }
        
        titlesData = await titlesResponse.json();
        console.log('DEBUG: API response for project', projectId, ':', {
          total_titles: titlesData.total_titles,
          clusters_with_content: titlesData.clusters_with_content,
          first_title: titlesData.content[0]?.content,
          response_url: titlesResponse.url
        });
        
        // Hide loading
        document.getElementById('loading').classList.add('hidden');
        
        if (titlesData.total_titles === 0) {
          // Show no titles message
          document.getElementById('no-titles').classList.remove('hidden');
        } else {
          // Show titles
          displayTitles();
        }
        
      } catch (error) {
        console.error('Failed to load titles:', error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('status-text').textContent = 'Error: ' + error.message;
        
        // Show error message
        document.body.innerHTML += `
          <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded max-w-md">
              <strong class="font-bold">Error loading titles:</strong>
              <span class="block sm:inline"> ${error.message}</span>
              <div class="mt-4">
                <a href="/" class="text-blue-600 hover:text-blue-800">← Back to Dashboard</a>
              </div>
            </div>
          </div>
        `;
      }
    });
    
    function displayTitles() {
      // Show project info
      document.getElementById('project-info').classList.remove('hidden');
      document.getElementById('project-subtitle').textContent = 
        `${currentProject.name} - ${titlesData.total_titles} FAQ titles across ${titlesData.clusters_with_content} clusters`;
      
      // Show titles content
      document.getElementById('titles-content').classList.remove('hidden');
      document.getElementById('titles-count').textContent = titlesData.total_titles;
      document.getElementById('clusters-count').textContent = titlesData.clusters_with_content;
      
      // Setup view switcher
      setupViewSwitcher();
      
      // Render initial view
      renderCurrentView();
      
      // Setup export button
      document.getElementById('export-titles').addEventListener('click', exportTitles);
      
      // Setup mark as used/unused buttons
      document.getElementById('mark-used-btn').addEventListener('click', () => markFilteredTitlesAsUsed(true));
      document.getElementById('mark-unused-btn').addEventListener('click', () => markFilteredTitlesAsUsed(false));
      
      // Setup filters
      setupFilters();
    }
    
    function setupViewSwitcher() {
      const detailedBtn = document.getElementById('detailed-view-btn');
      const plainBtn = document.getElementById('plain-view-btn');
      
      detailedBtn.addEventListener('click', () => switchView('detailed'));
      plainBtn.addEventListener('click', () => switchView('plain'));
    }
    
    function switchView(viewMode) {
      if (currentViewMode === viewMode) return;
      
      currentViewMode = viewMode;
      updateViewButtons();
      renderCurrentView();
    }
    
    function updateViewButtons() {
      const detailedBtn = document.getElementById('detailed-view-btn');
      const plainBtn = document.getElementById('plain-view-btn');
      
      if (currentViewMode === 'detailed') {
        detailedBtn.className = 'px-3 py-1 text-sm font-medium rounded-md transition-colors bg-blue-500 text-white';
        plainBtn.className = 'px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white';
      } else {
        detailedBtn.className = 'px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white';
        plainBtn.className = 'px-3 py-1 text-sm font-medium rounded-md transition-colors bg-blue-500 text-white';
      }
    }
    
    function renderCurrentView() {
      const clustersContainer = document.getElementById('clusters-container');
      const plainTextContainer = document.getElementById('plain-text-container');
      
      if (currentViewMode === 'detailed') {
        // Show detailed view
        clustersContainer.classList.remove('hidden');
        plainTextContainer.classList.add('hidden');
        renderDetailedView();
      } else {
        // Show plain text view
        clustersContainer.classList.add('hidden');
        plainTextContainer.classList.remove('hidden');
        renderPlainTextView();
      }
    }
    
    function renderDetailedView() {
      const container = document.getElementById('clusters-container');
      container.innerHTML = '';
      
      // Sort clusters alphabetically for consistent ordering
      const sortedClusters = Object.keys(titlesData.by_cluster).sort();
      sortedClusters.forEach(clusterName => {
        const clusterData = titlesData.by_cluster[clusterName];
        const clusterElement = createClusterSection(clusterName, clusterData);
        container.appendChild(clusterElement);
      });
    }
    
    function renderPlainTextView() {
      const plainTextContent = document.getElementById('plain-text-content');
      const allTitles = [];
      const filteredTitles = [];
      
      // Collect all titles from all clusters - sort clusters alphabetically for consistency
      const sortedClusters = Object.keys(titlesData.by_cluster).sort();
      sortedClusters.forEach(clusterName => {
        const clusterData = titlesData.by_cluster[clusterName];
        clusterData.titles.forEach(title => {
          allTitles.push({
            id: title.id,
            content: title.content,
            cluster: clusterName,
            created_at: title.created_at,
            is_approved: title.is_approved,
            is_used: title.is_used,
            quality_score: title.quality_score
          });
        });
      });
      
      // Apply filters
      const filtered = applyFilters(allTitles);
      
      // Update filter counts
      updateFilterCounts(filtered.length, allTitles.length);
      
      // Store filtered titles data for later use
      window.currentFilteredTitles = filtered;
      
      // Display filtered titles one per line in textarea
      plainTextContent.value = filtered.map(title => title.content).join('\n');
    }
    
    function createClusterSection(clusterName, clusterData) {
      const section = document.createElement('div');
      section.className = 'bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden';
      
      section.innerHTML = `
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 p-6 border-b border-gray-200 dark:border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">🏷️ ${clusterName}</h3>
              ${clusterData.cluster_description ? 
                `<p class="text-gray-600 dark:text-gray-400 mb-3">${clusterData.cluster_description}</p>` : ''}
            </div>
            <div class="text-right">
              <div class="inline-flex items-center px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 rounded-full text-sm font-medium">
                ${clusterData.titles.length} titles
              </div>
            </div>
          </div>
        </div>
        
        <div class="p-6">
          <div class="grid gap-4">
            ${clusterData.titles.map(title => createTitleItem(title)).join('')}
          </div>
        </div>
      `;
      
      return section;
    }
    
    function createTitleItem(title) {
      const approvedBadge = title.is_approved ? 
        '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">Approved</span>' : 
        '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">Pending</span>';
      
      const usedBadge = title.is_used ?
        '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">✅ Used</span>' :
        '<span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded">🆕 Unused</span>';
      
      const qualityScore = title.quality_score ? 
        `<span class="text-xs text-tertiary">Quality: ${(title.quality_score * 100).toFixed(0)}%</span>` : '';
      
      return `
        <div class="bg-primary p-4 rounded border-l-4 border-accent-green">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <h4 class="font-medium text-primary text-lg mb-2">${title.content}</h4>
              <div class="flex items-center space-x-4 text-xs text-secondary">
                <span>📝 ${title.word_count || 0} words</span>
                <span>📏 ${title.character_count || 0} chars</span>
                ${qualityScore}
                <span>📅 ${new Date(title.created_at).toLocaleDateString()}</span>
              </div>
              ${title.related_keyword ? `
                <div class="mt-2 text-xs text-tertiary">
                  🔗 Related: "${title.related_keyword}" (Vol: ${title.search_volume || 'N/A'}, Comp: ${title.competition || 'N/A'})
                </div>
              ` : ''}
            </div>
            <div class="ml-4 flex flex-col gap-2">
              ${approvedBadge}
              ${usedBadge}
            </div>
          </div>
        </div>
      `;
    }
    
    function setupFilters() {
      // Populate cluster filter options
      const clusterOptions = document.getElementById('cluster-options');
      // Sort clusters alphabetically for consistent ordering
      const clusters = Object.keys(titlesData.by_cluster).sort();
      
      clusters.forEach(clusterName => {
        const label = document.createElement('label');
        label.className = 'flex items-center p-1 hover:bg-gray-50 dark:hover:bg-gray-600 rounded';
        label.innerHTML = `
          <input type="checkbox" value="${clusterName}" class="cluster-filter-checkbox mr-2">
          <span class="text-sm">${clusterName}</span>
        `;
        clusterOptions.appendChild(label);
      });
      
      // Setup dropdown toggles
      setupDropdownToggle('date');
      setupDropdownToggle('cluster');
      setupDropdownToggle('quality');
      setupDropdownToggle('status');
      
      // Add event listeners for checkboxes
      document.addEventListener('change', function(e) {
        if (e.target.classList.contains('date-filter-checkbox') ||
            e.target.classList.contains('cluster-filter-checkbox') ||
            e.target.classList.contains('quality-filter-checkbox') ||
            e.target.classList.contains('status-filter-checkbox')) {
          handleFilterChange();
        }
      });
      
      // Setup select/deselect all buttons
      setupSelectAllButtons();
      
      // Clear filters button
      document.getElementById('clear-filters').addEventListener('click', clearFilters);
      
      // Close dropdowns when clicking outside
      document.addEventListener('click', closeDropdownsOnOutsideClick);
      
      // Initial filter count update
      updateFilterDisplay();
      if (currentViewMode === 'plain') {
        renderPlainTextView();
      }
    }
    
    function setupDropdownToggle(filterType) {
      const btn = document.getElementById(`${filterType}-filter-btn`);
      const dropdown = document.getElementById(`${filterType}-filter-dropdown`);
      const arrow = document.getElementById(`${filterType}-filter-arrow`);
      
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        
        // Close other dropdowns
        ['date', 'cluster', 'quality', 'status'].forEach(type => {
          if (type !== filterType) {
            document.getElementById(`${type}-filter-dropdown`).classList.add('hidden');
            document.getElementById(`${type}-filter-arrow`).style.transform = 'rotate(0deg)';
          }
        });
        
        // Toggle current dropdown
        const isHidden = dropdown.classList.contains('hidden');
        if (isHidden) {
          dropdown.classList.remove('hidden');
          arrow.style.transform = 'rotate(180deg)';
        } else {
          dropdown.classList.add('hidden');
          arrow.style.transform = 'rotate(0deg)';
        }
      });
    }
    
    function setupSelectAllButtons() {
      // Date filter
      document.getElementById('date-select-all').addEventListener('click', () => {
        document.querySelectorAll('.date-filter-checkbox').forEach(cb => {
          cb.checked = true;
        });
        handleFilterChange();
      });
      
      document.getElementById('date-deselect-all').addEventListener('click', () => {
        document.querySelectorAll('.date-filter-checkbox').forEach(cb => {
          cb.checked = false;
        });
        handleFilterChange();
      });
      
      // Cluster filter
      document.getElementById('cluster-select-all').addEventListener('click', () => {
        document.querySelectorAll('.cluster-filter-checkbox').forEach(cb => {
          cb.checked = true;
        });
        handleFilterChange();
      });
      
      document.getElementById('cluster-deselect-all').addEventListener('click', () => {
        document.querySelectorAll('.cluster-filter-checkbox').forEach(cb => {
          cb.checked = false;
        });
        handleFilterChange();
      });
      
      // Quality filter
      document.getElementById('quality-select-all').addEventListener('click', () => {
        document.querySelectorAll('.quality-filter-checkbox').forEach(cb => {
          cb.checked = true;
        });
        handleFilterChange();
      });
      
      document.getElementById('quality-deselect-all').addEventListener('click', () => {
        document.querySelectorAll('.quality-filter-checkbox').forEach(cb => {
          cb.checked = false;
        });
        handleFilterChange();
      });
      
      // Status filter
      document.getElementById('status-select-all').addEventListener('click', () => {
        document.querySelectorAll('.status-filter-checkbox').forEach(cb => {
          cb.checked = true;
        });
        handleFilterChange();
      });
      
      document.getElementById('status-deselect-all').addEventListener('click', () => {
        document.querySelectorAll('.status-filter-checkbox').forEach(cb => {
          cb.checked = false;
        });
        handleFilterChange();
      });
    }
    
    function closeDropdownsOnOutsideClick(e) {
      if (!e.target.closest('#filter-toolbar')) {
        ['date', 'cluster', 'quality', 'status'].forEach(type => {
          document.getElementById(`${type}-filter-dropdown`).classList.add('hidden');
          document.getElementById(`${type}-filter-arrow`).style.transform = 'rotate(0deg)';
        });
      }
    }
    
    function handleFilterChange() {
      // Update filter state based on checked checkboxes
      filterState.date = Array.from(document.querySelectorAll('.date-filter-checkbox:checked')).map(cb => cb.value);
      filterState.cluster = Array.from(document.querySelectorAll('.cluster-filter-checkbox:checked')).map(cb => cb.value);
      filterState.quality = Array.from(document.querySelectorAll('.quality-filter-checkbox:checked')).map(cb => cb.value);
      filterState.status = Array.from(document.querySelectorAll('.status-filter-checkbox:checked')).map(cb => cb.value);
      
      // Update display
      updateFilterDisplay();
      
      // Re-render if in plain text view
      if (currentViewMode === 'plain') {
        renderPlainTextView();
      }
      
      updateActiveFiltersDisplay();
    }
    
    function updateFilterDisplay() {
      // Update date filter button text
      const dateText = filterState.date.length === 0 ? 'Date (0 selected)' : `Date (${filterState.date.length} selected)`;
      document.getElementById('date-filter-text').textContent = dateText;
      
      // Update cluster filter button text
      const clusterText = filterState.cluster.length === 0 ? 'Cluster (0 selected)' : `Cluster (${filterState.cluster.length} selected)`;
      document.getElementById('cluster-filter-text').textContent = clusterText;
      
      // Update quality filter button text
      const qualityText = filterState.quality.length === 0 ? 'Quality (0 selected)' : `Quality (${filterState.quality.length} selected)`;
      document.getElementById('quality-filter-text').textContent = qualityText;
      
      // Update status filter button text
      const statusText = filterState.status.length === 0 ? 'Status (0 selected)' : `Status (${filterState.status.length} selected)`;
      document.getElementById('status-filter-text').textContent = statusText;
    }
    
    function clearFilters() {
      filterState = {
        date: [],
        cluster: [],
        quality: [],
        status: []
      };
      
      // Uncheck all checkboxes
      document.querySelectorAll('.date-filter-checkbox, .cluster-filter-checkbox, .quality-filter-checkbox, .status-filter-checkbox').forEach(cb => {
        cb.checked = false;
      });
      
      // Update display
      updateFilterDisplay();
      
      // Re-render if in plain text view
      if (currentViewMode === 'plain') {
        renderPlainTextView();
      }
      
      updateActiveFiltersDisplay();
    }
    
    function applyFilters(titles) {
      return titles.filter(title => {
        // Date filter - if any date filters are selected, title must match at least one
        if (filterState.date.length > 0) {
          const titleDate = new Date(title.created_at);
          const now = new Date();
          let dateMatches = false;
          
          for (const dateFilter of filterState.date) {
            switch (dateFilter) {
              case 'today':
                if (titleDate.toDateString() === now.toDateString()) {
                  dateMatches = true;
                }
                break;
              case 'week':
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                if (titleDate >= weekAgo) {
                  dateMatches = true;
                }
                break;
              case 'month':
                const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                if (titleDate >= monthAgo) {
                  dateMatches = true;
                }
                break;
            }
          }
          
          if (!dateMatches) return false;
        }
        
        // Cluster filter - if any cluster filters are selected, title must match at least one
        if (filterState.cluster.length > 0 && !filterState.cluster.includes(title.cluster)) {
          return false;
        }
        
        // Quality filter - if any quality filters are selected, title must match at least one
        if (filterState.quality.length > 0) {
          if (title.quality_score === null || title.quality_score === undefined) {
            return false; // Exclude titles without quality scores when quality filter is active
          }
          
          const qualityPercent = title.quality_score * 100;
          let qualityMatches = false;
          
          for (const qualityFilter of filterState.quality) {
            switch (qualityFilter) {
              case 'high':
                if (qualityPercent > 80) {
                  qualityMatches = true;
                }
                break;
              case 'medium':
                if (qualityPercent > 50 && qualityPercent <= 80) {
                  qualityMatches = true;
                }
                break;
              case 'low':
                if (qualityPercent <= 50) {
                  qualityMatches = true;
                }
                break;
            }
          }
          
          if (!qualityMatches) return false;
        }
        
        // Status filter - if any status filters are selected, title must match at least one
        if (filterState.status.length > 0) {
          let statusMatches = false;
          
          for (const statusFilter of filterState.status) {
            switch (statusFilter) {
              case 'used':
                if (title.is_used) {
                  statusMatches = true;
                }
                break;
              case 'unused':
                if (!title.is_used) {
                  statusMatches = true;
                }
                break;
            }
          }
          
          if (!statusMatches) return false;
        }
        
        return true;
      });
    }
    
    function updateFilterCounts(filteredCount, totalCount) {
      document.getElementById('filtered-count').textContent = filteredCount;
      document.getElementById('total-count').textContent = totalCount;
    }
    
    function updateActiveFiltersDisplay() {
      const activeFilters = [];
      
      if (filterState.date.length > 0) {
        const dateLabels = {
          today: 'Today',
          week: 'This Week',
          month: 'This Month'
        };
        const dateNames = filterState.date.map(d => dateLabels[d]).join(', ');
        activeFilters.push(`📅 ${dateNames}`);
      }
      
      if (filterState.cluster.length > 0) {
        const clusterNames = filterState.cluster.length > 2 ? 
          `${filterState.cluster.slice(0, 2).join(', ')} +${filterState.cluster.length - 2} more` :
          filterState.cluster.join(', ');
        activeFilters.push(`🏷️ ${clusterNames}`);
      }
      
      if (filterState.quality.length > 0) {
        const qualityLabels = {
          high: 'High',
          medium: 'Medium',
          low: 'Low'
        };
        const qualityNames = filterState.quality.map(q => qualityLabels[q]).join(', ');
        activeFilters.push(`⭐ ${qualityNames}`);
      }
      
      if (filterState.status.length > 0) {
        const statusLabels = {
          used: 'Used',
          unused: 'Unused'
        };
        const statusNames = filterState.status.map(s => statusLabels[s]).join(', ');
        activeFilters.push(`📝 ${statusNames}`);
      }
      
      const activeFiltersElement = document.getElementById('active-filters');
      if (activeFilters.length > 0) {
        const totalSelected = filterState.date.length + filterState.cluster.length + filterState.quality.length + filterState.status.length;
        activeFiltersElement.textContent = `(${totalSelected} filters active)`;
        activeFiltersElement.title = activeFilters.join(', ');
      } else {
        activeFiltersElement.textContent = '';
        activeFiltersElement.title = '';
      }
    }
    
    async function markFilteredTitlesAsUsed(isUsed) {
      if (!titlesData || titlesData.total_titles === 0) return;
      
      // Get current content from textarea
      const plainTextContent = document.getElementById('plain-text-content');
      const textareaLines = plainTextContent.value.split('\n').filter(line => line.trim() !== '');
      
      if (textareaLines.length === 0) {
        alert('No titles to process. The text area is empty.');
        return;
      }
      
      // Match textarea lines with original title data
      const titlesToProcess = [];
      textareaLines.forEach(line => {
        const trimmedLine = line.trim();
        // Find matching title from current filtered data
        const matchingTitle = window.currentFilteredTitles?.find(title => 
          title.content.trim() === trimmedLine
        );
        if (matchingTitle) {
          titlesToProcess.push(matchingTitle);
        } else {
          console.warn('Could not find matching title for:', trimmedLine);
        }
      });
      
      if (titlesToProcess.length === 0) {
        alert('No matching titles found. Make sure the titles in the text area match the original filtered titles.');
        return;
      }
      
      // Confirm action
      const action = isUsed ? 'mark as used' : 'mark as unused';
      const confirmation = confirm(`Are you sure you want to ${action} ${titlesToProcess.length} title(s) one by one?`);
      if (!confirmation) return;
      
      // Disable buttons during processing
      const markUsedBtn = document.getElementById('mark-used-btn');
      const markUnusedBtn = document.getElementById('mark-unused-btn');
      markUsedBtn.disabled = true;
      markUnusedBtn.disabled = true;
      
      let successCount = 0;
      let errorCount = 0;
      const statusText = document.getElementById('status-text');
      const originalStatus = statusText.textContent;
      
      try {
        // Process each title individually
        for (let i = 0; i < titlesToProcess.length; i++) {
          const title = titlesToProcess[i];
          
          // Update button text with progress
          const progress = `(${i + 1}/${titlesToProcess.length})`;
          markUsedBtn.textContent = isUsed ? `⏳ Marking... ${progress}` : '✅ Mark as Used';
          markUnusedBtn.textContent = !isUsed ? `⏳ Marking... ${progress}` : '↩️ Mark as Unused';
          statusText.textContent = `Processing ${i + 1}/${titlesToProcess.length}: "${title.content.substring(0, 50)}..."`;
          
          try {
            // Make individual API call
            const response = await fetch('/api/generated-content/mark-used', {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                projectId: parseInt(projectId),
                titleIds: [title.id],
                isUsed: isUsed
              })
            });
            
            if (!response.ok) {
              throw new Error(`Failed to update title: ${response.status}`);
            }
            
            const result = await response.json();
            console.log(`Title ${i + 1} marked:`, result);
            
            // Update local data immediately
            Object.entries(titlesData.by_cluster).forEach(([clusterName, clusterData]) => {
              clusterData.titles.forEach(localTitle => {
                if (localTitle.id === title.id) {
                  localTitle.is_used = isUsed;
                }
              });
            });
            
            // Update the content array as well
            titlesData.content.forEach(localTitle => {
              if (localTitle.id === title.id) {
                localTitle.is_used = isUsed;
              }
            });
            
            successCount++;
            
            // Small delay between requests to avoid overwhelming the server
            await new Promise(resolve => setTimeout(resolve, 100));
            
          } catch (error) {
            console.error(`Error marking title ${i + 1}:`, error);
            errorCount++;
          }
        }
        
        // Final status update
        if (errorCount === 0) {
          statusText.textContent = `✅ Successfully marked ${successCount} title(s) as ${isUsed ? 'used' : 'unused'}`;
        } else {
          statusText.textContent = `⚠️ Marked ${successCount} title(s), ${errorCount} failed`;
        }
        
        // Re-render the current view to reflect changes
        renderCurrentView();
        
      } catch (error) {
        console.error('Error in batch marking:', error);
        statusText.textContent = 'Error processing titles: ' + error.message;
      } finally {
        // Re-enable buttons
        markUsedBtn.disabled = false;
        markUnusedBtn.disabled = false;
        markUsedBtn.textContent = '✅ Mark as Used';
        markUnusedBtn.textContent = '↩️ Mark as Unused';
        
        // Reset status after 5 seconds
        setTimeout(() => {
          statusText.textContent = originalStatus;
        }, 5000);
      }
    }
    
    function exportTitles() {
      if (!titlesData || titlesData.total_titles === 0) return;
      
      // Generate CSV
      const headers = ['Cluster', 'Title', 'Word Count', 'Character Count', 'Quality Score', 'Approved', 'Created Date', 'Related Keyword'];
      const rows = [headers];
      
      Object.entries(titlesData.by_cluster).forEach(([clusterName, clusterData]) => {
        clusterData.titles.forEach(title => {
          rows.push([
            clusterName,
            title.content,
            title.word_count || 0,
            title.character_count || 0,
            title.quality_score ? (title.quality_score * 100).toFixed(0) + '%' : '',
            title.is_approved ? 'Yes' : 'No',
            new Date(title.created_at).toLocaleDateString(),
            title.related_keyword || ''
          ]);
        });
      });
      
      const csvContent = rows.map(row => 
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
      ).join('\n');
      
      // Download CSV
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `faq-titles-${currentProject.name.replace(/[^a-zA-Z0-9]/g, '_')}-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>