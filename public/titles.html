<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAQ Titles Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/components.css">
</head>
<body class="bg-primary text-primary">
  <div id="app" class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 shadow-lg">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <!-- Left: Logo and navigation -->
          <div class="flex items-center space-x-8">
            <a href="/" class="text-white text-xl font-bold hover:text-blue-200 transition-colors">
              üìä Keywords Cluster Tool
            </a>
            <nav class="hidden md:flex items-center space-x-4 text-sm">
              <a href="/" class="text-blue-100 hover:text-white transition-colors px-3 py-2 rounded-md">Dashboard</a>
              <span class="text-blue-200">‚Ä∫</span>
              <span id="project-name-breadcrumb" class="text-blue-100">Project</span>
              <span class="text-blue-200">‚Ä∫</span>
              <span class="text-white font-medium">FAQ Titles</span>
            </nav>
          </div>
          
          <!-- Right: Control buttons -->
          <div class="flex items-center space-x-3">
            <button id="theme-toggle" class="relative w-12 h-6 bg-white bg-opacity-20 rounded-full transition-all duration-200 cursor-pointer">
              <div id="theme-slider" class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-transform duration-200 shadow-sm"></div>
            </button>
          </div>
        </div>
      </div>
    </header>
    
    <!-- Main content -->
    <main class="flex-1 bg-gray-50 dark:bg-gray-900">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading state -->
        <div id="loading" class="text-center py-16">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full mb-6">
            <div class="animate-spin rounded-full h-8 w-8 border-2 border-white border-t-transparent"></div>
          </div>
          <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-2">Loading FAQ Titles</h2>
          <p class="text-gray-600 dark:text-gray-400">Fetching your generated content...</p>
        </div>
      
        <!-- Project info -->
        <div id="project-info" class="mb-8 hidden">
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-3">üéØ Generated FAQ Titles</h1>
          <p class="text-lg text-gray-600 dark:text-gray-400" id="project-subtitle">Loading...</p>
        </div>
      
        <!-- No titles message -->
        <div id="no-titles" class="text-center py-16 hidden">
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-12 max-w-2xl mx-auto">
            <div class="text-8xl mb-6">üìù</div>
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">No FAQ Titles Yet</h2>
            <p class="text-xl text-gray-600 dark:text-gray-400 mb-6">This project doesn't have any generated FAQ titles.</p>
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-6 mb-8">
              <p class="text-blue-800 dark:text-blue-200 font-medium">üí° Getting Started</p>
              <p class="text-blue-700 dark:text-blue-300 mt-2">Use the CLI command "Generate More Content" to create FAQ titles from your keyword clusters.</p>
            </div>
            <a href="/" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-200 shadow-lg">
              ‚Üê Back to Dashboard
            </a>
          </div>
        </div>
      
        <!-- Titles content -->
        <div id="titles-content" class="hidden">
          <!-- Stats and controls -->
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
              <div class="flex items-center space-x-6">
                <div class="text-center">
                  <div id="titles-count" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Total Titles</div>
                </div>
                <div class="text-center">
                  <div id="clusters-count" class="text-2xl font-bold text-purple-600 dark:text-purple-400">0</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Clusters</div>
                </div>
              </div>
              <div class="flex space-x-3">
                <a href="/" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                  ‚Üê Dashboard
                </a>
                <a id="project-link" href="#" class="px-4 py-2 bg-blue-100 dark:bg-blue-700 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-600 transition-colors">
                  üóÇÔ∏è Project Keywords
                </a>
                <button id="export-titles" class="px-4 py-2 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg hover:from-green-600 hover:to-blue-600 transition-all duration-200 shadow-md">
                  üìä Export CSV
                </button>
              </div>
            </div>
          </div>
          
          <!-- Clusters container -->
          <div id="clusters-container" class="space-y-8">
            <!-- Clusters with titles will be rendered here -->
          </div>
        </div>
      </div>
    </main>
    
    <!-- Footer -->
    <footer class="bg-gray-800 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex items-center justify-between">
          <span id="status-text" class="text-sm text-gray-400">Ready</span>
          <div class="text-xs text-gray-500">
            Keywords Cluster Tool ¬© 2024
          </div>
        </div>
      </div>
    </footer>
  </div>
  
  <!-- Scripts -->
  <script src="js/theme-handler.js"></script>
  
  <script>
    let currentProject = null;
    let titlesData = null;
    
    // Extract project ID from URL query parameter or path
    const urlParams = new URLSearchParams(window.location.search);
    let projectId = urlParams.get('project');
    
    // Fallback to path-based extraction for legacy URLs
    if (!projectId) {
      const pathParts = window.location.pathname.split('/');
      projectId = pathParts[2]; // /project/{id}/titles
    }
    
    if (!projectId) {
      alert('No project ID specified. Please use /titles?project=1 format.');
      window.location.href = '/';
    }
    
    // Load project and titles data
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        console.log('Loading titles for project:', projectId);
        
        // Load dashboard to get project info
        const dashboardResponse = await fetch('/api/dashboard');
        const dashboardData = await dashboardResponse.json();
        
        // Find current project
        currentProject = dashboardData.projects.find(p => p.id == projectId);
        if (currentProject) {
          document.getElementById('project-name-breadcrumb').textContent = currentProject.name;
          document.title = `FAQ Titles - ${currentProject.name}`;
        } else {
          document.getElementById('project-name-breadcrumb').textContent = `Project ${projectId}`;
          document.title = `FAQ Titles - Project ${projectId}`;
        }
        
        // Set up project link
        document.getElementById('project-link').href = `/project.html?id=${projectId}`;
        
        // Load generated content
        const titlesResponse = await fetch(`/api/generated-content/${projectId}`);
        if (!titlesResponse.ok) {
          throw new Error(`Failed to load titles: ${titlesResponse.status}`);
        }
        
        titlesData = await titlesResponse.json();
        console.log('Titles data:', titlesData);
        
        // Hide loading
        document.getElementById('loading').classList.add('hidden');
        
        if (titlesData.total_titles === 0) {
          // Show no titles message
          document.getElementById('no-titles').classList.remove('hidden');
        } else {
          // Show titles
          displayTitles();
        }
        
      } catch (error) {
        console.error('Failed to load titles:', error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('status-text').textContent = 'Error: ' + error.message;
        
        // Show error message
        document.body.innerHTML += `
          <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded max-w-md">
              <strong class="font-bold">Error loading titles:</strong>
              <span class="block sm:inline"> ${error.message}</span>
              <div class="mt-4">
                <a href="/" class="text-blue-600 hover:text-blue-800">‚Üê Back to Dashboard</a>
              </div>
            </div>
          </div>
        `;
      }
    });
    
    function displayTitles() {
      // Show project info
      document.getElementById('project-info').classList.remove('hidden');
      document.getElementById('project-subtitle').textContent = 
        `${currentProject.name} - ${titlesData.total_titles} FAQ titles across ${titlesData.clusters_with_content} clusters`;
      
      // Show titles content
      document.getElementById('titles-content').classList.remove('hidden');
      document.getElementById('titles-count').textContent = titlesData.total_titles;
      document.getElementById('clusters-count').textContent = titlesData.clusters_with_content;
      
      // Render clusters
      const container = document.getElementById('clusters-container');
      container.innerHTML = '';
      
      Object.entries(titlesData.by_cluster).forEach(([clusterName, clusterData]) => {
        const clusterElement = createClusterSection(clusterName, clusterData);
        container.appendChild(clusterElement);
      });
      
      // Setup export button
      document.getElementById('export-titles').addEventListener('click', exportTitles);
    }
    
    function createClusterSection(clusterName, clusterData) {
      const section = document.createElement('div');
      section.className = 'bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden';
      
      section.innerHTML = `
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 p-6 border-b border-gray-200 dark:border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">üè∑Ô∏è ${clusterName}</h3>
              ${clusterData.cluster_description ? 
                `<p class="text-gray-600 dark:text-gray-400 mb-3">${clusterData.cluster_description}</p>` : ''}
            </div>
            <div class="text-right">
              <div class="inline-flex items-center px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 rounded-full text-sm font-medium">
                ${clusterData.titles.length} titles
              </div>
            </div>
          </div>
        </div>
        
        <div class="p-6">
          <div class="grid gap-4">
            ${clusterData.titles.map(title => createTitleItem(title)).join('')}
          </div>
        </div>
      `;
      
      return section;
    }
    
    function createTitleItem(title) {
      const approvedBadge = title.is_approved ? 
        '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">Approved</span>' : 
        '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">Pending</span>';
      
      const qualityScore = title.quality_score ? 
        `<span class="text-xs text-tertiary">Quality: ${(title.quality_score * 100).toFixed(0)}%</span>` : '';
      
      return `
        <div class="bg-primary p-4 rounded border-l-4 border-accent-green">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <h4 class="font-medium text-primary text-lg mb-2">${title.content}</h4>
              <div class="flex items-center space-x-4 text-xs text-secondary">
                <span>üìù ${title.word_count || 0} words</span>
                <span>üìè ${title.character_count || 0} chars</span>
                ${qualityScore}
                <span>üìÖ ${new Date(title.created_at).toLocaleDateString()}</span>
              </div>
              ${title.related_keyword ? `
                <div class="mt-2 text-xs text-tertiary">
                  üîó Related: "${title.related_keyword}" (Vol: ${title.search_volume || 'N/A'}, Comp: ${title.competition || 'N/A'})
                </div>
              ` : ''}
            </div>
            <div class="ml-4">
              ${approvedBadge}
            </div>
          </div>
        </div>
      `;
    }
    
    function exportTitles() {
      if (!titlesData || titlesData.total_titles === 0) return;
      
      // Generate CSV
      const headers = ['Cluster', 'Title', 'Word Count', 'Character Count', 'Quality Score', 'Approved', 'Created Date', 'Related Keyword'];
      const rows = [headers];
      
      Object.entries(titlesData.by_cluster).forEach(([clusterName, clusterData]) => {
        clusterData.titles.forEach(title => {
          rows.push([
            clusterName,
            title.content,
            title.word_count || 0,
            title.character_count || 0,
            title.quality_score ? (title.quality_score * 100).toFixed(0) + '%' : '',
            title.is_approved ? 'Yes' : 'No',
            new Date(title.created_at).toLocaleDateString(),
            title.related_keyword || ''
          ]);
        });
      });
      
      const csvContent = rows.map(row => 
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
      ).join('\n');
      
      // Download CSV
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `faq-titles-${currentProject.name.replace(/[^a-zA-Z0-9]/g, '_')}-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>